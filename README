# Git TG Bot – контейнерный стек

Этот проект поднимает связку сервисов для телеграм‑бота и сервиса аутентификации по GitHub токенам.

## Состав

| Сервис        | Назначение                                  | Порты |
|---------------|---------------------------------------------|-------|
| `auth-db`     | PostgreSQL 17 (alpine)                      | `DB_PORT` (по умолчанию 5432) |
| `kafka`       | Kafka 4.1.1 (официальный Apache, режим KRaft) | `KAFKA_BOOTSTRAP_PORT` (по умолчанию 9092) |
| `auth-service`| Spring Boot сервис авторизации              | `AUTH_SERVICE_PORT` (по умолчанию 8080) |
| `bot-service` | Python (Aiogram) бот                        | –     |

Все контейнеры подключены к сети `backend` и используют именованные volume `auth-db-data` и `kafka-data`.

## Подготовка окружения

1. Скопируй пример переменных:
   ```sh
   cp .env.example .env
   ```
2. Заполни обязательные значения:
   - `BOT_TOKEN` — токен Telegram‑бота.
   - При необходимости измени параметры БД и Kafka (`DB_*`, `KAFKA_*`).
3. Убедись, что `.env` доступен как общий файл окружения (можно указать альтернативный путь через `COMPOSE_ENV_FILE`).

## Запуск

```sh
docker compose up -d --build
```

Команда выполнит:

- сборку `AuthService` (Gradle/JDK 21) и `BotService` (Python 3.11-slim);
- поднятие PostgreSQL и Kafka с healthcheck;
- автоматическую выдачу переменных сервисам из общего `.env` и сервисных `.env`.

Проверить состояние:

```sh
docker compose ps
```

Просмотр логов конкретного контейнера:

```sh
docker compose logs -f auth-service
```

## Завершение работы

```sh
docker compose down
```

Чтобы очистить данные Postgres и Kafka:

```sh
docker compose down -v
```

## Полезные заметки

- `auth-service` слушает Kafka топик `task_user_token` и обращается к GitHub API.
- `bot-service` использует `KAFKA_BOOTSTRAP_SERVERS` из `.env` и отправляет токены в Kafka.
- `kafka` конфигурируется через переменные `KAFKA_BOOTSTRAP_HOST/PORT`, `KAFKA_CONTROLLER_HOST/PORT`, `KAFKA_CLUSTER_ID` и др., что упрощает замену окружений без правки Compose файла.
- При миграции с Bitnami-образа используй переменную `KAFKA_CLUSTER_ID` и удали устаревший `KAFKA_KRAFT_CLUSTER_ID`, иначе Apache Kafka не стартует.
- Значения `DB_URL`, `SRC_BROKER` и т.д. переопределяются через переменные окружения без правки Compose файла.

Следуй этой инструкции, и стек будет стабильно подниматься на любой машине с Docker.
